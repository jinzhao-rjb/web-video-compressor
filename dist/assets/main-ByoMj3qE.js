(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();let y=null,W=null;const h=document.getElementById("uploadArea"),j=document.getElementById("fileInput"),Z=document.getElementById("browseBtn"),ee=document.getElementById("originalVideoContainer"),w=document.getElementById("originalVideo"),te=document.getElementById("originalInfo"),oe=document.getElementById("originalFileName"),ne=document.getElementById("originalFileSize"),re=document.getElementById("originalDuration"),ie=document.getElementById("originalResolution"),P=document.getElementById("qualitySlider"),ae=document.getElementById("qualityValue"),b=document.getElementById("resolutionSelect"),v=document.getElementById("compressBtn"),G=document.getElementById("progressContainer"),T=document.getElementById("progressFill"),x=document.getElementById("progressText"),se=document.getElementById("compressedVideoContainer"),d=document.getElementById("compressedVideo"),de=document.getElementById("compressedInfo"),ce=document.getElementById("compressedFileName"),le=document.getElementById("compressedFileSize"),me=document.getElementById("compressionRatio"),ue=document.getElementById("spaceSaved"),F=document.getElementById("downloadBtn"),pe=document.getElementById("comparisonContainer"),ge=document.getElementById("noComparison"),fe=document.getElementById("compareOriginalVideo"),K=document.getElementById("compareCompressedVideo");function ve(){ye(),_()}function ye(){Z.addEventListener("click",()=>j.click()),j.addEventListener("change",he),h.addEventListener("dragover",Be),h.addEventListener("dragleave",Ee),h.addEventListener("drop",we),P.addEventListener("input",_),b.addEventListener("change",()=>{console.log("分辨率已更改:",b.value)}),v.addEventListener("click",Le)}function _(){ae.textContent=`${P.value}%`}function he(t){t.target.files.length>0&&Q(t.target.files[0])}function Be(t){t.preventDefault(),h.classList.add("dragover")}function Ee(t){t.preventDefault(),h.classList.remove("dragover")}function we(t){t.preventDefault(),h.classList.remove("dragover"),t.dataTransfer.files.length>0&&Q(t.dataTransfer.files[0])}function Q(t){if(!t.type.startsWith("video/")){alert("请上传视频文件！");return}if(t.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}y=t,Ie(t),v.disabled=!1}function Ie(t){const e=URL.createObjectURL(t);w.src=e,fe.src=e,ee.classList.remove("hidden"),w.onloadedmetadata=()=>{te.classList.remove("hidden"),oe.textContent=t.name,ne.textContent=V(t.size),re.textContent=be(w.duration),ie.textContent=`${w.videoWidth} × ${w.videoHeight}`}}async function Le(){if(y){v.disabled=!0,v.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',G.classList.remove("hidden"),T.style.width="0%",x.textContent="0%";try{const t=P.value,e=parseFloat(b.value);W=await Se(y,t,e),Fe(W),J()}catch(t){console.error("压缩失败:",t),alert("视频压缩失败，请重试！")}finally{v.disabled=!1,v.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',G.classList.add("hidden")}}}async function Se(t,e,r){return new Promise((a,n)=>{const o=document.createElement("video");o.src=URL.createObjectURL(t),o.playsInline=!0,o.muted=!0,o.preload="metadata",o.onloadedmetadata=async()=>{try{let R=function(){if($)return;const m=(Date.now()-X)/1e3,A=Math.min(m,S);I.drawImage(o,0,0,f,B);const N=Date.now();if(N-q>=Y){const H=Math.min(100,Math.round(A/S*100));T.style.width=`${H}%`,x.textContent=`${H}%`,q=N}if(A>=S){$=!0,E.stop(),o.pause(),T.style.width="100%",x.textContent="100%";return}requestAnimationFrame(R)};var c=R;const s=Math.round(o.videoWidth*r),l=Math.round(o.videoHeight*r),f=s%2===0?s:s-1,B=l%2===0?l:l-1,p=document.createElement("canvas");p.width=f,p.height=B;const I=p.getContext("2d",{willReadFrequently:!0}),u=o.videoFrameRate||30,z=1e3/u,i=new MediaStream;await o.play();const D=o.captureStream(u).getAudioTracks();D.forEach(m=>{i.addTrack(m)}),p.captureStream(u).getVideoTracks().forEach(m=>{i.addTrack(m)}),console.log(`检测到 ${D.length} 个音频轨道`);let g="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(g)||(g="video/webm;codecs=vp9,opus",MediaRecorder.isTypeSupported(g)||(g=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4"));const L=Ce(e,f,B,u),C=128e3,U=L+C,M={mimeType:g,videoBitsPerSecond:L,audioBitsPerSecond:C,bitsPerSecond:U,frameRate:u,ignoreMutedMedia:!1,videoEncodingBitrate:L,audioEncodingBitrate:C};g.includes("webm")?M.bitsPerSecond=U:g.includes("mp4")&&(M.videoBitsPerSecond=L);const E=new MediaRecorder(i,M),k=[];E.ondataavailable=m=>{m.data.size>0&&k.push(m.data)},E.onstop=()=>{const m=new Blob(k,{type:E.mimeType,lastModified:Date.now()});a(m)},E.start(500);const S=o.duration;o.playbackRate=1;let X=Date.now(),q=0,$=!1;const xe=Math.ceil(S*u),Y=100;requestAnimationFrame(R),o.play()}catch(s){console.error("压缩过程错误:",s),n(s)}},o.onerror=c=>{console.error("视频加载错误:",c),n(new Error("视频加载失败"))}})}function Ce(t,e,r,a=30){const n=e*r*a*.15,o=t/100;return Math.round(n*o)}async function Me(t){console.log("Using optimized method to fix video metadata");try{const e=t.type;return console.log("Original blob type:",e),e.includes("mp4")?new Blob([t],{type:"video/mp4",lastModified:Date.now()}):await Re(t)}catch(e){return console.error("Video metadata fix failed:",e),t}}async function Re(t){console.log("Converting video to MP4 format");const e=document.createElement("video");e.src=URL.createObjectURL(t),e.muted=!0,e.playsInline=!0,e.preload="auto",await new Promise((i,O)=>{e.onloadedmetadata=i,e.onerror=O}),await e.play(),e.pause();const r=document.createElement("canvas");r.width=e.videoWidth,r.height=e.videoHeight;const a=r.getContext("2d"),n=e.videoFrameRate||30,o=1e3/n,c=r.captureStream(n);let s="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(s)||(s="video/mp4");const l=new MediaRecorder(c,{mimeType:s,videoBitsPerSecond:2e6,audioBitsPerSecond:128e3,frameRate:n}),f=[];l.ondataavailable=i=>{i.data.size>0&&f.push(i.data)};const B=new Promise(i=>{l.onstop=()=>{i(new Blob(f,{type:s,lastModified:Date.now()}))}});l.start(1e3),e.play();let p=!0,I=0;const u=i=>{p&&(i-I>=o&&(a.drawImage(e,0,0,r.width,r.height),I=i),!e.paused&&!e.ended?requestAnimationFrame(u):(p=!1,l.stop()))};requestAnimationFrame(u),await new Promise(i=>{e.onended=i});const z=await B;return e.pause(),URL.revokeObjectURL(e.src),z}async function Fe(t){const e=await Me(t),r=URL.createObjectURL(e);d.src=r,K.src=r,d.controls=!0,K.controls=!0,se.classList.remove("hidden"),F.href=r;const a=y.name.replace(/\.[^/.]+$/,"");F.download=`compressed_${a}.mp4`,F.classList.remove("hidden"),J(),d.onloadedmetadata=()=>{de.classList.remove("hidden"),ce.textContent=`compressed_${y.name}`,le.textContent=V(e.size);const n=y.size,o=e.size,c=((1-o/n)*100).toFixed(1),s=n-o;me.textContent=`${c}%`,ue.textContent=V(s),d.play().then(()=>{setTimeout(()=>{d.pause(),d.currentTime=0,console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",d.duration),console.log("视频可拖动范围:",d.seekable)},100)}).catch(l=>{console.error("视频播放失败:",l)})},d.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),d.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",d.currentTime)})}function J(){pe.classList.remove("hidden"),ge.classList.add("hidden")}function V(t){if(t===0)return"0 Bytes";const e=1024,r=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,a)).toFixed(2))+" "+r[a]}function be(t){const e=Math.floor(t/60),r=Math.floor(t%60);return`${e}:${r.toString().padStart(2,"0")}`}ve();
