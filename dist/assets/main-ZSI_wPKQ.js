(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();let y=null,W=null;const h=document.getElementById("uploadArea"),j=document.getElementById("fileInput"),Z=document.getElementById("browseBtn"),ee=document.getElementById("originalVideoContainer"),L=document.getElementById("originalVideo"),te=document.getElementById("originalInfo"),oe=document.getElementById("originalFileName"),ne=document.getElementById("originalFileSize"),re=document.getElementById("originalDuration"),ie=document.getElementById("originalResolution"),z=document.getElementById("qualitySlider"),ae=document.getElementById("qualityValue"),F=document.getElementById("resolutionSelect"),v=document.getElementById("compressBtn"),G=document.getElementById("progressContainer"),x=document.getElementById("progressFill"),V=document.getElementById("progressText"),se=document.getElementById("compressedVideoContainer"),c=document.getElementById("compressedVideo"),de=document.getElementById("compressedInfo"),ce=document.getElementById("compressedFileName"),le=document.getElementById("compressedFileSize"),me=document.getElementById("compressionRatio"),ue=document.getElementById("spaceSaved"),b=document.getElementById("downloadBtn"),pe=document.getElementById("comparisonContainer"),ge=document.getElementById("noComparison"),fe=document.getElementById("compareOriginalVideo"),K=document.getElementById("compareCompressedVideo");function ve(){ye(),_()}function ye(){Z.addEventListener("click",()=>j.click()),j.addEventListener("change",he),h.addEventListener("dragover",Be),h.addEventListener("dragleave",Ee),h.addEventListener("drop",we),z.addEventListener("input",_),F.addEventListener("change",()=>{console.log("分辨率已更改:",F.value)}),v.addEventListener("click",Le)}function _(){ae.textContent=`${z.value}%`}function he(e){e.target.files.length>0&&Q(e.target.files[0])}function Be(e){e.preventDefault(),h.classList.add("dragover")}function Ee(e){e.preventDefault(),h.classList.remove("dragover")}function we(e){e.preventDefault(),h.classList.remove("dragover"),e.dataTransfer.files.length>0&&Q(e.dataTransfer.files[0])}function Q(e){if(!e.type.startsWith("video/")){alert("请上传视频文件！");return}if(e.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}y=e,Ie(e),v.disabled=!1}function Ie(e){const t=URL.createObjectURL(e);L.src=t,fe.src=t,ee.classList.remove("hidden"),L.onloadedmetadata=()=>{te.classList.remove("hidden"),oe.textContent=e.name,ne.textContent=P(e.size),re.textContent=be(L.duration),ie.textContent=`${L.videoWidth} × ${L.videoHeight}`}}async function Le(){if(y){v.disabled=!0,v.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',G.classList.remove("hidden"),x.style.width="0%",V.textContent="0%";try{const e=z.value,t=parseFloat(F.value);W=await Se(y,e,t),Te(W),J()}catch(e){console.error("压缩失败:",e),alert("视频压缩失败，请重试！")}finally{v.disabled=!1,v.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',G.classList.add("hidden")}}}async function Se(e,t,r){return new Promise((a,n)=>{const o=document.createElement("video");o.src=URL.createObjectURL(e),o.playsInline=!0,o.muted=!0,o.preload="metadata",o.onloadedmetadata=async()=>{try{let T=function(){if(q)return;const m=(Date.now()-X)/1e3,N=Math.min(m,R);E.drawImage(o,0,0,f,B);const A=Date.now();if(A-$>=Y){const H=Math.min(100,Math.round(N/R*100));x.style.width=`${H}%`,V.textContent=`${H}%`,$=A}if(N>=R){q=!0,I.stop(),o.pause(),x.style.width="100%",V.textContent="100%";return}requestAnimationFrame(T)};var l=T;const s=Math.round(o.videoWidth*r),d=Math.round(o.videoHeight*r),f=s%2===0?s:s-1,B=d%2===0?d:d-1,p=document.createElement("canvas");p.width=f,p.height=B;const E=p.getContext("2d",{willReadFrequently:!0}),u=o.videoFrameRate||30,O=1e3/u,i=new MediaStream;await o.play();const D=o.captureStream(u).getAudioTracks();D.forEach(m=>{i.addTrack(m)}),p.captureStream(u).getVideoTracks().forEach(m=>{i.addTrack(m)}),console.log(`检测到 ${D.length} 个音频轨道`);let g="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(g)||(g="video/webm;codecs=vp9,opus",MediaRecorder.isTypeSupported(g)||(g=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4"));const S=Re(t,f,B,u),C=128e3,U=S+C,M={mimeType:g,videoBitsPerSecond:S,audioBitsPerSecond:C,bitsPerSecond:U,frameRate:u,ignoreMutedMedia:!1,videoEncodingBitrate:S,audioEncodingBitrate:C};g.includes("webm")?M.bitsPerSecond=U:g.includes("mp4")&&(M.videoBitsPerSecond=S);const I=new MediaRecorder(i,M),k=[];I.ondataavailable=m=>{m.data.size>0&&k.push(m.data)},I.onstop=()=>{const m=new Blob(k,{type:I.mimeType,lastModified:Date.now()});a(m)},I.start(500);const R=o.duration;o.playbackRate=1;let X=Date.now(),$=0,q=!1;const xe=Math.ceil(R*u),Y=100;requestAnimationFrame(T),o.play()}catch(s){console.error("压缩过程错误:",s),n(s)}},o.onerror=l=>{console.error("视频加载错误:",l),n(new Error("视频加载失败"))}})}function Re(e,t,r,a=30){const n=t*r*a*.15,o=e/100;return Math.round(n*o)}async function Ce(e){console.log("Using optimized method to fix video metadata");try{const t=e.type;return console.log("Original blob type:",t),t.includes("mp4")?new Blob([e],{type:"video/mp4",lastModified:Date.now()}):await Me(e)}catch(t){return console.error("Video metadata fix failed:",t),e}}async function Me(e){console.log("Converting video to MP4 format");const t=document.createElement("video");t.src=URL.createObjectURL(e),t.muted=!0,t.playsInline=!0,t.preload="auto",await new Promise((i,w)=>{t.onloadedmetadata=i,t.onerror=w}),await t.play(),t.pause();const r=document.createElement("canvas");r.width=t.videoWidth,r.height=t.videoHeight;const a=r.getContext("2d"),n=t.videoFrameRate||30,o=1e3/n,l=r.captureStream(n);let s="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(s)||(s="video/mp4");const d=new MediaRecorder(l,{mimeType:s,videoBitsPerSecond:2e6,audioBitsPerSecond:128e3,frameRate:n}),f=[];d.ondataavailable=i=>{i.data.size>0&&f.push(i.data)};const B=new Promise(i=>{d.onstop=()=>{i(new Blob(f,{type:s,lastModified:Date.now()}))}});d.start(1e3);let p=!0,E=0;d.start(1e3);const u=async()=>{if(!p||E>=t.duration){p=!1,d.stop();return}t.currentTime=E,await new Promise(i=>{t.onseeked=i}),a.drawImage(t,0,0,r.width,r.height),E+=o/1e3,setTimeout(u,o)};u(),await new Promise(i=>{const w=()=>{p?setTimeout(w,100):i()};w()});const O=await B;return t.pause(),URL.revokeObjectURL(t.src),O}async function Te(e){const t=await Ce(e),r=URL.createObjectURL(t);c.src=r,K.src=r,c.controls=!0,K.controls=!0,se.classList.remove("hidden"),b.href=r;const a=y.name.replace(/\.[^/.]+$/,"");b.download=`compressed_${a}.mp4`,b.classList.remove("hidden"),J(),c.onloadedmetadata=()=>{de.classList.remove("hidden"),ce.textContent=`compressed_${y.name}`,le.textContent=P(t.size);const n=y.size,o=t.size,l=((1-o/n)*100).toFixed(1),s=n-o;me.textContent=`${l}%`,ue.textContent=P(s),c.play().then(()=>{setTimeout(()=>{c.pause(),c.currentTime=0,console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",c.duration),console.log("视频可拖动范围:",c.seekable)},100)}).catch(d=>{console.error("视频播放失败:",d)})},c.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),c.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",c.currentTime)})}function J(){pe.classList.remove("hidden"),ge.classList.add("hidden")}function P(e){if(e===0)return"0 Bytes";const t=1024,r=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(2))+" "+r[a]}function be(e){const t=Math.floor(e/60),r=Math.floor(e%60);return`${t}:${r.toString().padStart(2,"0")}`}ve();
