(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const d of e.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function i(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(n){if(n.ep)return;n.ep=!0;const e=i(n);fetch(n.href,e)}})();let y=null,q=null;const h=document.getElementById("uploadArea"),N=document.getElementById("fileInput"),X=document.getElementById("browseBtn"),Y=document.getElementById("originalVideoContainer"),c=document.getElementById("originalVideo"),Z=document.getElementById("originalInfo"),ee=document.getElementById("originalFileName"),te=document.getElementById("originalFileSize"),oe=document.getElementById("originalDuration"),ne=document.getElementById("originalResolution"),z=document.getElementById("qualitySlider"),re=document.getElementById("qualityValue"),V=document.getElementById("resolutionSelect"),f=document.getElementById("compressBtn"),P=document.getElementById("progressContainer"),b=document.getElementById("progressFill"),O=document.getElementById("progressText"),ie=document.getElementById("compressedVideoContainer"),m=document.getElementById("compressedVideo"),se=document.getElementById("compressedInfo"),ae=document.getElementById("compressedFileName"),ce=document.getElementById("compressedFileSize"),de=document.getElementById("compressionRatio"),le=document.getElementById("spaceSaved"),M=document.getElementById("downloadBtn"),me=document.getElementById("comparisonContainer"),ue=document.getElementById("noComparison"),I=document.getElementById("compareOriginalVideo"),A=document.getElementById("compareCompressedVideo");function pe(){ge(),H()}function ge(){X.addEventListener("click",()=>N.click()),N.addEventListener("change",fe),h.addEventListener("dragover",ye),h.addEventListener("dragleave",he),h.addEventListener("drop",ve),z.addEventListener("input",H),V.addEventListener("change",()=>{console.log("分辨率已更改:",V.value)}),f.addEventListener("click",Ee)}function H(){re.textContent=`${z.value}%`}function fe(t){t.target.files.length>0&&W(t.target.files[0])}function ye(t){t.preventDefault(),h.classList.add("dragover")}function he(t){t.preventDefault(),h.classList.remove("dragover")}function ve(t){t.preventDefault(),h.classList.remove("dragover"),t.dataTransfer.files.length>0&&W(t.dataTransfer.files[0])}function W(t){if(!t.type.startsWith("video/")){alert("请上传视频文件！");return}if(t.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}y=t,Be(t),f.disabled=!1}function Be(t){const o=URL.createObjectURL(t);c.src=o,c.crossOrigin="anonymous",c.playsInline=!0,c.muted=!0,I.src=o,I.crossOrigin="anonymous",I.playsInline=!0,I.muted=!0,Y.classList.remove("hidden"),c.onloadedmetadata=()=>{Z.classList.remove("hidden"),ee.textContent=t.name,te.textContent=R(t.size),oe.textContent=Te(c.duration),ne.textContent=`${c.videoWidth} × ${c.videoHeight}`,resizeVideoForMobile(c)}}async function Ee(){if(y){f.disabled=!0,f.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',P.classList.remove("hidden"),b.style.width="0%",O.textContent="0%";try{const t=z.value,o=parseFloat(V.value);q=await Ie(y,t,o),Se(q),G()}catch(t){console.error("压缩失败:",t),alert("视频压缩失败，请重试！")}finally{f.disabled=!1,f.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',P.classList.add("hidden")}}}async function Ie(t,o,i){return new Promise((s,n)=>{const e=document.createElement("video");e.src=URL.createObjectURL(t),e.playsInline=!0,e.muted=!0,e.preload="auto",e.crossOrigin="anonymous",e.onloadedmetadata=async()=>{try{let C=function(){if(l)return;if(Date.now()-$>3e3){console.log("视频可能卡住，尝试恢复播放");try{e.currentTime=Math.min(e.currentTime+1,g-1),e.play().catch(a=>console.error("恢复播放失败:",a))}catch(a){console.error("调整视频位置失败:",a),l=!0,u.stop(),e.pause()}}l||setTimeout(C,2e3)},x=function(){if(!l){try{K.drawImage(e,0,0,w,S);const r=Date.now();if(r-U>=Q){const a=Math.min(100,Math.round(e.currentTime/g*100));b.style.width=`${a}%`,O.textContent=`${a}%`,U=r}}catch(r){console.error("绘制帧失败:",r)}requestAnimationFrame(x)}};var d=C,D=x;const p=Math.round(e.videoWidth*i),L=Math.round(e.videoHeight*i),w=p%2===0?p:p-1,S=L%2===0?L:L-1,v=document.createElement("canvas");v.width=w,v.height=S;const K=v.getContext("2d"),E=e.videoFrameRate||30;let T="video/mp4";MediaRecorder.isTypeSupported(T)||(T=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4");const _=Le(o,w,S,E),j={mimeType:T,videoBitsPerSecond:_,audioBitsPerSecond:128e3};let B;try{await e.play();const r=e.captureStream(E),a=v.captureStream(E);B=new MediaStream,r.getAudioTracks().forEach(F=>{B.addTrack(F)}),a.getVideoTracks().forEach(F=>{B.addTrack(F)})}catch(r){console.warn("音频处理失败，将仅处理视频:",r),B=v.captureStream(E)}const u=new MediaRecorder(B,j),k=[];u.ondataavailable=r=>{r.data.size>0&&k.push(r.data)},u.onstop=()=>{const r=new Blob(k,{type:u.mimeType,lastModified:Date.now()});s(r)},u.start(1e3);const g=e.duration;e.playbackRate=1;let U=0,l=!1;const Q=200;e.addEventListener("ended",()=>{console.log("视频播放结束，停止录制"),l=!0,u.stop(),e.pause(),b.style.width="100%",O.textContent="100%"});let $=0;e.addEventListener("timeupdate",()=>{$=Date.now(),e.currentTime>=g-.5&&!l&&console.log("视频接近结束，准备停止录制")}),setTimeout(C,3e3),requestAnimationFrame(x);try{await e.play(),console.log("视频播放开始，总时长:",g)}catch(r){console.error("视频播放失败:",r);try{e.muted=!0,await e.play(),console.log("静音模式下视频播放成功")}catch(a){console.error("静音播放也失败:",a),n(new Error("视频播放失败，请确保已授予必要的权限"));return}}const J=g*3;setTimeout(()=>{l||(console.log("超时强制停止，当前进度:",(e.currentTime/g*100).toFixed(2)+"%"),l=!0,u.stop(),e.pause())},J*1e3)}catch(p){console.error("压缩过程错误:",p),n(p)}},e.onerror=d=>{console.error("视频加载错误:",d),n(new Error("视频加载失败"))}})}function Le(t,o,i,s=30){const n=o*i*s*.15,e=t/100;return Math.round(n*e)}async function we(t){console.log("Using optimized method to fix video metadata");try{const o=t.type;return console.log("Original blob type:",o),o.includes("mp4")?new Blob([t],{type:"video/mp4",lastModified:Date.now()}):t}catch(o){return console.error("Video metadata fix failed:",o),t}}async function Se(t){const o=await we(t),i=URL.createObjectURL(o);m.src=i,A.src=i,m.controls=!0,A.controls=!0,ie.classList.remove("hidden"),M.href=i;const s=y.name.replace(/\.[^/.]+$/,"");M.download=`compressed_${s}.mp4`,M.classList.remove("hidden"),G(),m.onloadedmetadata=()=>{se.classList.remove("hidden"),ae.textContent=`compressed_${y.name}`,ce.textContent=R(o.size);const n=y.size,e=o.size,d=((1-e/n)*100).toFixed(1),D=n-e;de.textContent=`${d}%`,le.textContent=R(D),console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",m.duration),console.log("视频可拖动范围:",m.seekable)},m.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),m.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",m.currentTime)})}function G(){me.classList.remove("hidden"),ue.classList.add("hidden")}function R(t){if(t===0)return"0 Bytes";const o=1024,i=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(t)/Math.log(o));return parseFloat((t/Math.pow(o,s)).toFixed(2))+" "+i[s]}function Te(t){const o=Math.floor(t/60),i=Math.floor(t%60);return`${o}:${i.toString().padStart(2,"0")}`}pe();
