(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const e of r)if(e.type==="childList")for(const a of e.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function o(r){const e={};return r.integrity&&(e.integrity=r.integrity),r.referrerPolicy&&(e.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?e.credentials="include":r.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function n(r){if(r.ep)return;r.ep=!0;const e=o(r);fetch(r.href,e)}})();let E=null,S=null;const p=document.getElementById("uploadArea"),J=document.getElementById("fileInput"),ce=document.getElementById("browseBtn"),q=document.getElementById("originalVideoContainer"),g=document.getElementById("originalVideo"),de=document.getElementById("originalInfo"),le=document.getElementById("originalFileName"),me=document.getElementById("originalFileSize"),ue=document.getElementById("originalDuration"),pe=document.getElementById("originalResolution"),C=document.getElementById("qualitySlider"),ge=document.getElementById("qualityValue"),V=document.getElementById("resolutionSelect"),h=document.getElementById("compressBtn"),Y=document.getElementById("progressContainer"),U=document.getElementById("progressFill"),z=document.getElementById("progressText"),N=document.getElementById("compressedVideoContainer"),c=document.getElementById("compressedVideo"),fe=document.getElementById("compressedInfo"),ve=document.getElementById("compressedFileName"),ye=document.getElementById("compressedFileSize"),he=document.getElementById("compressionRatio"),Ee=document.getElementById("spaceSaved"),P=document.getElementById("downloadBtn"),A=document.getElementById("comparisonContainer"),we=document.getElementById("noComparison"),F=document.getElementById("compareOriginalVideo"),R=document.getElementById("compareCompressedVideo");function Le(){be(),W(),Be(),Me()}function be(){ce.addEventListener("click",()=>J.click()),J.addEventListener("change",Te),p.addEventListener("dragover",Se),p.addEventListener("dragleave",Ce),p.addEventListener("drop",ke),C.addEventListener("input",W),V.addEventListener("change",()=>{console.log("分辨率已更改:",V.value)}),h.addEventListener("click",Re)}function W(){ge.textContent=`${C.value}%`}function Be(){p.addEventListener("touchstart",()=>{p.classList.add("dragover")}),p.addEventListener("touchend",()=>{p.classList.remove("dragover")}),[q,N].forEach(o=>{o.addEventListener("dblclick",()=>{const n=o.querySelector("video");n&&Ie(n)})});let i=0;A.addEventListener("touchstart",o=>{i=o.touches[0].clientX}),A.addEventListener("touchend",o=>{const r=o.changedTouches[0].clientX-i;Math.abs(r)>50&&console.log("Swipe detected:",r>0?"right":"left")})}function Me(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(document.body.classList.add("mobile-device"),console.log("Mobile device detected, applying mobile optimizations"),C.value=Math.min(C.value,80),W(),document.addEventListener("click",i=>{[q,N].forEach(n=>{n.contains(i.target)})}))}function Ie(t){document.fullscreenElement?document.exitFullscreen():t.requestFullscreen().catch(i=>{console.error(`Error attempting to enable fullscreen: ${i.message}`)})}function te(t){document.body.classList.contains("mobile-device")&&t.videoWidth>1280&&t.classList.add("mobile-video")}function Te(t){t.target.files.length>0&&oe(t.target.files[0])}function Se(t){t.preventDefault(),p.classList.add("dragover")}function Ce(t){t.preventDefault(),p.classList.remove("dragover")}function ke(t){t.preventDefault(),p.classList.remove("dragover"),t.dataTransfer.files.length>0&&oe(t.dataTransfer.files[0])}function oe(t){if(!t.type.startsWith("video/")){alert("请上传视频文件！");return}if(t.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}E=t,Fe(t),h.disabled=!1}function Fe(t){const i=URL.createObjectURL(t);g.src=i,g.crossOrigin="anonymous",g.playsInline=!0,g.muted=!0,F.src=i,F.crossOrigin="anonymous",F.playsInline=!0,F.muted=!0,q.classList.remove("hidden"),g.onloadedmetadata=()=>{de.classList.remove("hidden"),le.textContent=t.name,me.textContent=$(t.size),ue.textContent=Pe(g.duration),pe.textContent=`${g.videoWidth} × ${g.videoHeight}`,te(g)}}async function Re(){let t=!1;const i=async(n,r)=>{console.error(`压缩${r}阶段出错:`,n);let e;if(n.name==="NotSupportedError"||n.message?.includes("encoding")?e="不支持的视频编码格式，请尝试降低质量设置":n.name==="OutOfMemoryError"||n.message?.includes("memory")?e="内存不足，请尝试选择更小的视频或降低质量":n.name==="AbortError"?e="压缩已被取消":e=`压缩失败: ${n.message||"未知错误"}`,alert(e),!t&&r!=="fallback"){t=!0,alert("正在尝试使用基础压缩模式...");try{return await o(),!0}catch(a){return console.error("回退压缩也失败:",a),alert("所有压缩模式都失败，请尝试选择其他视频文件"),!1}}return!1},o=async()=>{h.disabled=!0,h.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 尝试基础压缩...';try{return S=await Z(E,20,.5),await ee(S),D(),alert("基础压缩模式成功！"),S}catch{throw new Error("回退压缩失败")}};if(!E){alert("请先选择要压缩的视频文件");return}h.disabled=!0,h.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',Y.classList.remove("hidden"),U.style.width="0%",z.textContent="0%";try{const n=C.value,r=parseFloat(V.value),e=document.getElementById("fastModeToggle")?.checked||!1;if(!E.type.startsWith("video/")){alert("请选择有效的视频文件");return}const a=performance.now();try{S=await Z(E,n,r);const w=((performance.now()-a)/1e3).toFixed(2);await ee(S),D(),alert(`压缩成功！用时: ${w} 秒`)}catch(m){if(!await i(m,"主压缩"))throw m}}catch(n){console.error("处理压缩请求时出错:",n)}finally{h.disabled=!1,h.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',Y.classList.add("hidden")}}async function Z(t,i,o){return new Promise((n,r)=>{const e=document.createElement("video");e.src=URL.createObjectURL(t),e.playsInline=!0,e.muted=!0,e.preload="auto",e.crossOrigin="anonymous",e.onloadedmetadata=async()=>{try{let H=function(){const s=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),_=s?["video/mp4;codecs=avc1.42c01e,aac","video/mp4","video/webm;codecs=vp8,vorbis"]:["video/mp4;codecs=avc1.42E01E,mp4a.40.2","video/mp4","video/webm;codecs=vp9,opus","video/webm"];console.log("检测支持的MIME类型，设备类型:",s?"移动端":"桌面端");for(const y of _){if(MediaRecorder.isTypeSupported(y))return console.log("选择MIME类型:",y),y;console.log("不支持的MIME类型:",y)}return console.log("使用最基础的MP4格式"),"video/mp4"},x=function(){if(v)return;if(Date.now()-K>3e3){console.log("视频可能卡住，尝试恢复播放");try{e.currentTime=Math.min(e.currentTime+1,I-1),e.play().catch(u=>console.error("恢复播放失败:",u))}catch(u){console.error("调整视频位置失败:",u),v=!0,b.stop(),e.pause()}}v||setTimeout(x,2e3)},O=function(){if(!v){try{k.drawImage(e,0,0,d,L);const s=Date.now();if(s-G>=ie){const u=Math.min(100,Math.round(e.currentTime/I*100));U.style.width=`${u}%`,z.textContent=`${u}%`,G=s}}catch(s){console.error("绘制帧失败:",s)}requestAnimationFrame(O)}};var a=H,m=x,w=O;const l=Math.round(e.videoWidth*o),B=Math.round(e.videoHeight*o),d=l%2===0?l:l-1,L=B%2===0?B:B-1,f=document.createElement("canvas");f.width=d,f.height=L;const k=f.getContext("2d");let M=e.videoFrameRate||30;navigator.userAgent.match(/mobile/i)&&(M=Math.min(M,24));let ne=H();const X=xe(i,d,L,M),j=128e3,Ve=X+j,re={mimeType:ne,videoBitsPerSecond:X,audioBitsPerSecond:j};let T;try{await e.play();const s=e.captureStream(M),u=f.captureStream(M);T=new MediaStream,s.getAudioTracks().forEach(y=>{T.addTrack(y)}),u.getVideoTracks().forEach(y=>{T.addTrack(y)})}catch(s){console.warn("音频处理失败，将仅处理视频:",s),T=f.captureStream(M)}const b=new MediaRecorder(T,re),Q=[];b.ondataavailable=s=>{s.data.size>0&&Q.push(s.data)},b.onstop=()=>{const s=new Blob(Q,{type:b.mimeType,lastModified:Date.now()});n(s)},b.start(1e3);const I=e.duration;e.playbackRate=1;let G=0,v=!1;const ie=200;e.addEventListener("ended",()=>{console.log("视频播放结束，停止录制"),v=!0,b.stop(),e.pause(),U.style.width="100%",z.textContent="100%"});let K=0;e.addEventListener("timeupdate",()=>{K=Date.now(),e.currentTime>=I-.5&&!v&&console.log("视频接近结束，准备停止录制")}),setTimeout(x,3e3),requestAnimationFrame(O);try{await e.play(),console.log("视频播放开始，总时长:",I)}catch(s){console.error("视频播放失败:",s);try{e.muted=!0,await e.play(),console.log("静音模式下视频播放成功")}catch(u){console.error("静音播放也失败:",u),r(new Error("视频播放失败，请确保已授予必要的权限"));return}}const se=I*3;setTimeout(()=>{v||(console.log("超时强制停止，当前进度:",(e.currentTime/I*100).toFixed(2)+"%"),v=!0,b.stop(),e.pause())},se*1e3)}catch(l){console.error("压缩过程错误:",l),r(l)}},e.onerror=a=>{console.error("视频加载错误:",a),r(new Error("视频加载失败"))}})}function xe(t,i,o,n=30){const r=i*o*n*.15,e=t/100;return Math.round(r*e)}async function Oe(t){try{const i=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);if(t.type.includes("mp4")){console.log("处理MP4文件元数据");const o=document.createElement("video"),n=URL.createObjectURL(t);if(await new Promise(d=>{o.oncanplaythrough=()=>d(!0),o.onerror=()=>d(!1),o.src=n,o.preload="metadata",setTimeout(()=>d(!1),3e3)}))return console.log("视频加载正常，无需修复"),URL.revokeObjectURL(n),t;console.log("尝试使用Canvas方法修复视频元数据"),await new Promise((d,L)=>{const f=setTimeout(()=>{console.warn("视频加载超时，尝试继续处理"),d()},5e3);o.onloadeddata=()=>{clearTimeout(f),d()},o.onerror=k=>{clearTimeout(f),console.error("视频加载错误:",k),L(k)},o.src=n});const e=document.createElement("canvas"),a=e.getContext("2d");e.width=o.videoWidth||640,e.height=o.videoHeight||360;let m;i?m="video/mp4":m=MediaRecorder.isTypeSupported("video/mp4")?"video/mp4":"video/webm";const w=e.captureStream(Math.min(o.videoFrameRate||30,30)),l=new MediaRecorder(w,{mimeType:m}),B=[];return l.ondataavailable=d=>B.push(d.data),i?(a.drawImage(o,0,0),l.start(),setTimeout(()=>{l.stop()},200)):(a.drawImage(o,0,0),l.start(),setTimeout(()=>l.stop(),300)),new Promise(d=>{l.onstop=()=>{const L=new Blob(B,{type:m});URL.revokeObjectURL(n),console.log("视频元数据修复完成"),d(L)}})}else return console.log("非MP4格式，使用基本处理"),t}catch(i){return console.error("视频元数据修复过程中出错:",i),t}}async function ee(t){const i=await Oe(t),o=URL.createObjectURL(i);c.src=o,R.src=o,c.playsInline=!0,c.muted=!0,R.playsInline=!0,R.muted=!0,c.controls=!0,R.controls=!0,N.classList.remove("hidden"),P.href=o;const n=E.name.replace(/\.[^/.]+$/,"");P.download=`compressed_${n}.mp4`,P.classList.remove("hidden"),D(),c.onloadedmetadata=()=>{fe.classList.remove("hidden"),ve.textContent=`compressed_${E.name}`,ye.textContent=$(i.size);const r=E.size,e=i.size,a=((1-e/r)*100).toFixed(1),m=r-e;he.textContent=`${a}%`,Ee.textContent=$(m),te(c),c.play().then(()=>{setTimeout(()=>{c.pause(),c.currentTime=0,console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",c.duration),console.log("视频可拖动范围:",c.seekable)},100)}).catch(w=>{console.error("视频自动播放失败:",w)})},c.onerror=r=>{console.error("压缩视频加载失败:",r),alert("视频加载失败，请尝试下载后观看")},c.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),c.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",c.currentTime)})}function D(){A.classList.remove("hidden"),we.classList.add("hidden")}function $(t){if(t===0)return"0 Bytes";const i=1024,o=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(t)/Math.log(i));return parseFloat((t/Math.pow(i,n)).toFixed(2))+" "+o[n]}function Pe(t){const i=Math.floor(t/60),o=Math.floor(t%60);return`${i}:${o.toString().padStart(2,"0")}`}Le();
