(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const m of e.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function r(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(n){if(n.ep)return;n.ep=!0;const e=r(n);fetch(n.href,e)}})();let w=null,G=null;const L=document.getElementById("uploadArea"),K=document.getElementById("fileInput"),oe=document.getElementById("browseBtn"),ne=document.getElementById("originalVideoContainer"),S=document.getElementById("originalVideo"),re=document.getElementById("originalInfo"),ie=document.getElementById("originalFileName"),ae=document.getElementById("originalFileSize"),se=document.getElementById("originalDuration"),de=document.getElementById("originalResolution"),$=document.getElementById("qualitySlider"),ce=document.getElementById("qualityValue"),D=document.getElementById("resolutionSelect"),B=document.getElementById("compressBtn"),_=document.getElementById("progressContainer"),U=document.getElementById("progressFill"),k=document.getElementById("progressText"),le=document.getElementById("compressedVideoContainer"),l=document.getElementById("compressedVideo"),me=document.getElementById("compressedInfo"),ue=document.getElementById("compressedFileName"),pe=document.getElementById("compressedFileSize"),ge=document.getElementById("compressionRatio"),fe=document.getElementById("spaceSaved"),O=document.getElementById("downloadBtn"),ve=document.getElementById("comparisonContainer"),ye=document.getElementById("noComparison"),he=document.getElementById("compareOriginalVideo"),Q=document.getElementById("compareCompressedVideo");function Ee(){Be(),J()}function Be(){oe.addEventListener("click",()=>K.click()),K.addEventListener("change",we),L.addEventListener("dragover",Le),L.addEventListener("dragleave",Ie),L.addEventListener("drop",Te),$.addEventListener("input",J),D.addEventListener("change",()=>{console.log("分辨率已更改:",D.value)}),B.addEventListener("click",Fe)}function J(){ce.textContent=`${$.value}%`}function we(o){o.target.files.length>0&&X(o.target.files[0])}function Le(o){o.preventDefault(),L.classList.add("dragover")}function Ie(o){o.preventDefault(),L.classList.remove("dragover")}function Te(o){o.preventDefault(),L.classList.remove("dragover"),o.dataTransfer.files.length>0&&X(o.dataTransfer.files[0])}function X(o){if(!o.type.startsWith("video/")){alert("请上传视频文件！");return}if(o.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}w=o,Se(o),B.disabled=!1}function Se(o){const t=URL.createObjectURL(o);S.src=t,he.src=t,ne.classList.remove("hidden"),S.onloadedmetadata=()=>{re.classList.remove("hidden"),ie.textContent=o.name,ae.textContent=q(o.size),se.textContent=Ve(S.duration),de.textContent=`${S.videoWidth} × ${S.videoHeight}`}}async function Fe(){if(w){B.disabled=!0,B.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',_.classList.remove("hidden"),U.style.width="0%",k.textContent="0%";try{const o=$.value,t=parseFloat(D.value);G=await Ce(w,o,t),xe(G),Y()}catch(o){console.error("压缩失败:",o),alert("视频压缩失败，请重试！")}finally{B.disabled=!1,B.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',_.classList.add("hidden")}}}async function Ce(o,t,r){return new Promise((a,n)=>{const e=document.createElement("video");e.src=URL.createObjectURL(o),e.playsInline=!0,e.muted=!0,e.preload="auto",e.onloadedmetadata=async()=>{try{let P=function(){if(u)return;Date.now()-j>2e3&&V&&(R++,console.log("视频可能卡住，尝试恢复播放，卡住次数:",R),R<5?e.play().catch(M=>{console.error("恢复播放失败:",M),e.currentTime<c-1&&(console.log("尝试调整视频位置，当前位置:",e.currentTime,"总时长:",c),e.currentTime=Math.min(e.currentTime+.5,c-1))}):(console.log("多次尝试恢复失败，强制停止"),u=!0,y.stop(),e.pause())),u||setTimeout(P,1e3)},z=function(){if(u)return;F.drawImage(e,0,0,I,E);const i=Date.now();if(i-W>=ee){const M=Math.min(100,Math.round(e.currentTime/c*100));U.style.width=`${M}%`,k.textContent=`${M}%`,W=i}requestAnimationFrame(z)};var m=P,g=z;const s=Math.round(e.videoWidth*r),h=Math.round(e.videoHeight*r),I=s%2===0?s:s-1,E=h%2===0?h:h-1,f=document.createElement("canvas");f.width=I,f.height=E;const F=f.getContext("2d",{willReadFrequently:!0}),p=e.videoFrameRate||30,d=1e3/p,T=new MediaStream;await e.play();const A=e.captureStream(p).getAudioTracks();A.forEach(i=>{T.addTrack(i)}),f.captureStream(p).getVideoTracks().forEach(i=>{T.addTrack(i)}),console.log(`检测到 ${A.length} 个音频轨道`);let v="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(v)||(v="video/webm;codecs=vp9,opus",MediaRecorder.isTypeSupported(v)||(v=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4"));const C=Re(t,I,E,p),b=128e3,N=C+b,x={mimeType:v,videoBitsPerSecond:C,audioBitsPerSecond:b,bitsPerSecond:N,frameRate:p,ignoreMutedMedia:!1,videoEncodingBitrate:C,audioEncodingBitrate:b};v.includes("webm")?x.bitsPerSecond=N:v.includes("mp4")&&(x.videoBitsPerSecond=C);const y=new MediaRecorder(T,x),H=[];y.ondataavailable=i=>{i.data.size>0&&H.push(i.data)},y.onstop=()=>{const i=new Blob(H,{type:y.mimeType,lastModified:Date.now()});a(i)},y.start(500);const c=e.duration;e.playbackRate=1;let W=0,u=!1,Z=!1;const Oe=Math.ceil(c*p),ee=100;e.addEventListener("ended",()=>{console.log("视频播放结束，停止录制"),u=!0,y.stop(),e.pause(),U.style.width="100%",k.textContent="100%"}),e.addEventListener("pause",()=>{console.log("视频暂停，当前进度:",(e.currentTime/c*100).toFixed(2)+"%"),!u&&e.currentTime<c-.5&&setTimeout(()=>{!u&&!Z&&(console.log("尝试继续播放视频"),e.play().catch(i=>console.error("Failed to continue playback:",i)))},100)});let V=!0,j=0,R=0;e.addEventListener("timeupdate",()=>{j=Date.now(),R=0,e.currentTime>=c-.5&&!u&&console.log("视频接近结束，准备停止录制")}),e.addEventListener("playing",()=>{V=!0,console.log("视频开始播放")}),e.addEventListener("waiting",()=>{V=!1,console.log("视频加载中...")}),setTimeout(P,2e3),requestAnimationFrame(z);try{await e.play(),console.log("视频播放开始，总时长:",c)}catch(i){console.error("视频播放失败:",i),n(i);return}e.playbackRate=1;const te=c*2;setTimeout(()=>{u||(console.log("超时强制停止，当前进度:",(e.currentTime/c*100).toFixed(2)+"%"),u=!0,y.stop(),e.pause())},te*1e3)}catch(s){console.error("压缩过程错误:",s),n(s)}},e.onerror=m=>{console.error("视频加载错误:",m),n(new Error("视频加载失败"))}})}function Re(o,t,r,a=30){const n=t*r*a*.15,e=o/100;return Math.round(n*e)}async function Me(o){console.log("Using optimized method to fix video metadata");try{const t=o.type;return console.log("Original blob type:",t),t.includes("mp4")?new Blob([o],{type:"video/mp4",lastModified:Date.now()}):await be(o)}catch(t){return console.error("Video metadata fix failed:",t),o}}async function be(o){console.log("Converting video to MP4 format");const t=document.createElement("video");t.src=URL.createObjectURL(o),t.muted=!0,t.playsInline=!0,t.preload="auto",await new Promise((d,T)=>{t.onloadedmetadata=d,t.onerror=T}),await t.play(),t.pause();const r=document.createElement("canvas");r.width=t.videoWidth,r.height=t.videoHeight;const a=r.getContext("2d"),n=t.videoFrameRate||30,e=1e3/n,m=r.captureStream(n);let g="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(g)||(g="video/mp4");const s=new MediaRecorder(m,{mimeType:g,videoBitsPerSecond:2e6,audioBitsPerSecond:128e3,frameRate:n}),h=[];s.ondataavailable=d=>{d.data.size>0&&h.push(d.data)};const I=new Promise(d=>{s.onstop=()=>{d(new Blob(h,{type:g,lastModified:Date.now()}))}});s.start(1e3),t.play();let E=!0,f=0;const F=d=>{E&&(d-f>=e&&(a.drawImage(t,0,0,r.width,r.height),f=d),!t.paused&&!t.ended?requestAnimationFrame(F):(E=!1,s.stop()))};requestAnimationFrame(F),await new Promise(d=>{t.onended=d});const p=await I;return t.pause(),URL.revokeObjectURL(t.src),p}async function xe(o){const t=await Me(o),r=URL.createObjectURL(t);l.src=r,Q.src=r,l.controls=!0,Q.controls=!0,le.classList.remove("hidden"),O.href=r;const a=w.name.replace(/\.[^/.]+$/,"");O.download=`compressed_${a}.mp4`,O.classList.remove("hidden"),Y(),l.onloadedmetadata=()=>{me.classList.remove("hidden"),ue.textContent=`compressed_${w.name}`,pe.textContent=q(t.size);const n=w.size,e=t.size,m=((1-e/n)*100).toFixed(1),g=n-e;ge.textContent=`${m}%`,fe.textContent=q(g),l.play().then(()=>{setTimeout(()=>{l.pause(),l.currentTime=0,console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",l.duration),console.log("视频可拖动范围:",l.seekable)},100)}).catch(s=>{console.error("视频播放失败:",s)})},l.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),l.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",l.currentTime)})}function Y(){ve.classList.remove("hidden"),ye.classList.add("hidden")}function q(o){if(o===0)return"0 Bytes";const t=1024,r=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(o)/Math.log(t));return parseFloat((o/Math.pow(t,a)).toFixed(2))+" "+r[a]}function Ve(o){const t=Math.floor(o/60),r=Math.floor(o%60);return`${t}:${r.toString().padStart(2,"0")}`}Ee();
