(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const d of e.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function i(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function a(n){if(n.ep)return;n.ep=!0;const e=i(n);fetch(n.href,e)}})();let y=null,A=null;const h=document.getElementById("uploadArea"),N=document.getElementById("fileInput"),X=document.getElementById("browseBtn"),Y=document.getElementById("originalVideoContainer"),L=document.getElementById("originalVideo"),Z=document.getElementById("originalInfo"),ee=document.getElementById("originalFileName"),te=document.getElementById("originalFileSize"),oe=document.getElementById("originalDuration"),ne=document.getElementById("originalResolution"),z=document.getElementById("qualitySlider"),re=document.getElementById("qualityValue"),M=document.getElementById("resolutionSelect"),f=document.getElementById("compressBtn"),P=document.getElementById("progressContainer"),V=document.getElementById("progressFill"),b=document.getElementById("progressText"),ie=document.getElementById("compressedVideoContainer"),s=document.getElementById("compressedVideo"),se=document.getElementById("compressedInfo"),ae=document.getElementById("compressedFileName"),ce=document.getElementById("compressedFileSize"),de=document.getElementById("compressionRatio"),le=document.getElementById("spaceSaved"),F=document.getElementById("downloadBtn"),me=document.getElementById("comparisonContainer"),ue=document.getElementById("noComparison"),pe=document.getElementById("compareOriginalVideo"),H=document.getElementById("compareCompressedVideo");function ge(){fe(),W()}function fe(){X.addEventListener("click",()=>N.click()),N.addEventListener("change",ye),h.addEventListener("dragover",he),h.addEventListener("dragleave",ve),h.addEventListener("drop",Ee),z.addEventListener("input",W),M.addEventListener("change",()=>{console.log("分辨率已更改:",M.value)}),f.addEventListener("click",Le)}function W(){re.textContent=`${z.value}%`}function ye(t){t.target.files.length>0&&G(t.target.files[0])}function he(t){t.preventDefault(),h.classList.add("dragover")}function ve(t){t.preventDefault(),h.classList.remove("dragover")}function Ee(t){t.preventDefault(),h.classList.remove("dragover"),t.dataTransfer.files.length>0&&G(t.dataTransfer.files[0])}function G(t){if(!t.type.startsWith("video/")){alert("请上传视频文件！");return}if(t.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}y=t,Be(t),f.disabled=!1}function Be(t){const o=URL.createObjectURL(t);L.src=o,pe.src=o,Y.classList.remove("hidden"),L.onloadedmetadata=()=>{Z.classList.remove("hidden"),ee.textContent=t.name,te.textContent=R(t.size),oe.textContent=Ce(L.duration),ne.textContent=`${L.videoWidth} × ${L.videoHeight}`}}async function Le(){if(y){f.disabled=!0,f.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',P.classList.remove("hidden"),V.style.width="0%",b.textContent="0%";try{const t=z.value,o=parseFloat(M.value);A=await Ie(y,t,o),Se(A),K()}catch(t){console.error("压缩失败:",t),alert("视频压缩失败，请重试！")}finally{f.disabled=!1,f.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',P.classList.add("hidden")}}}async function Ie(t,o,i){return new Promise((a,n)=>{const e=document.createElement("video");e.src=URL.createObjectURL(t),e.playsInline=!0,e.muted=!0,e.preload="auto",e.crossOrigin="anonymous",e.onloadedmetadata=async()=>{try{let S=function(){if(m)return;if(Date.now()-q>3e3){console.log("视频可能卡住，尝试恢复播放");try{e.currentTime=Math.min(e.currentTime+1,g-1),e.play().catch(c=>console.error("恢复播放失败:",c))}catch(c){console.error("调整视频位置失败:",c),m=!0,u.stop(),e.pause()}}m||setTimeout(S,2e3)},C=function(){if(!m){try{_.drawImage(e,0,0,w,T);const r=Date.now();if(r-$>=Q){const c=Math.min(100,Math.round(e.currentTime/g*100));V.style.width=`${c}%`,b.textContent=`${c}%`,$=r}}catch(r){console.error("绘制帧失败:",r)}requestAnimationFrame(C)}};var d=S,O=C;const l=Math.round(e.videoWidth*i),I=Math.round(e.videoHeight*i),w=l%2===0?l:l-1,T=I%2===0?I:I-1,v=document.createElement("canvas");v.width=w,v.height=T;const _=v.getContext("2d"),p=e.videoFrameRate||30;navigator.userAgent.match(/mobile/i)&&(p=Math.min(p,24));let E="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(E)||(E="video/mp4",MediaRecorder.isTypeSupported(E)||(E=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4"));const D=we(o,w,T,p),k=128e3,xe=D+k,j={mimeType:E,videoBitsPerSecond:D,audioBitsPerSecond:k};let B;try{await e.play();const r=e.captureStream(p),c=v.captureStream(p);B=new MediaStream,r.getAudioTracks().forEach(x=>{B.addTrack(x)}),c.getVideoTracks().forEach(x=>{B.addTrack(x)})}catch(r){console.warn("音频处理失败，将仅处理视频:",r),B=v.captureStream(p)}const u=new MediaRecorder(B,j),U=[];u.ondataavailable=r=>{r.data.size>0&&U.push(r.data)},u.onstop=()=>{const r=new Blob(U,{type:u.mimeType,lastModified:Date.now()});a(r)},u.start(1e3);const g=e.duration;e.playbackRate=1;let $=0,m=!1;const Q=200;e.addEventListener("ended",()=>{console.log("视频播放结束，停止录制"),m=!0,u.stop(),e.pause(),V.style.width="100%",b.textContent="100%"});let q=0;e.addEventListener("timeupdate",()=>{q=Date.now(),e.currentTime>=g-.5&&!m&&console.log("视频接近结束，准备停止录制")}),setTimeout(S,3e3),requestAnimationFrame(C);try{await e.play(),console.log("视频播放开始，总时长:",g)}catch(r){console.error("视频播放失败:",r);try{e.muted=!0,await e.play(),console.log("静音模式下视频播放成功")}catch(c){console.error("静音播放也失败:",c),n(new Error("视频播放失败，请确保已授予必要的权限"));return}}const J=g*3;setTimeout(()=>{m||(console.log("超时强制停止，当前进度:",(e.currentTime/g*100).toFixed(2)+"%"),m=!0,u.stop(),e.pause())},J*1e3)}catch(l){console.error("压缩过程错误:",l),n(l)}},e.onerror=d=>{console.error("视频加载错误:",d),n(new Error("视频加载失败"))}})}function we(t,o,i,a=30){const n=o*i*a*.15,e=t/100;return Math.round(n*e)}async function Te(t){console.log("Using optimized method to fix video metadata");try{const o=t.type;return console.log("Original blob type:",o),o.includes("mp4")?new Blob([t],{type:"video/mp4",lastModified:Date.now()}):t}catch(o){return console.error("Video metadata fix failed:",o),t}}async function Se(t){const o=await Te(t),i=URL.createObjectURL(o);s.src=i,H.src=i,s.controls=!0,H.controls=!0,ie.classList.remove("hidden"),F.href=i;const a=y.name.replace(/\.[^/.]+$/,"");F.download=`compressed_${a}.mp4`,F.classList.remove("hidden"),K(),s.onloadedmetadata=()=>{se.classList.remove("hidden"),ae.textContent=`compressed_${y.name}`,ce.textContent=R(o.size);const n=y.size,e=o.size,d=((1-e/n)*100).toFixed(1),O=n-e;de.textContent=`${d}%`,le.textContent=R(O),s.play().then(()=>{setTimeout(()=>{s.pause(),s.currentTime=0,console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",s.duration),console.log("视频可拖动范围:",s.seekable)},100)}).catch(l=>{console.error("视频自动播放失败:",l)})},s.onerror=n=>{console.error("压缩视频加载失败:",n),alert("视频加载失败，请尝试下载后观看")},s.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),s.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",s.currentTime)})}function K(){me.classList.remove("hidden"),ue.classList.add("hidden")}function R(t){if(t===0)return"0 Bytes";const o=1024,i=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(o));return parseFloat((t/Math.pow(o,a)).toFixed(2))+" "+i[a]}function Ce(t){const o=Math.floor(t/60),i=Math.floor(t%60);return`${o}:${i.toString().padStart(2,"0")}`}ge();
