(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();let y=null,N=null;const h=document.getElementById("uploadArea"),H=document.getElementById("fileInput"),X=document.getElementById("browseBtn"),Y=document.getElementById("originalVideoContainer"),w=document.getElementById("originalVideo"),Z=document.getElementById("originalInfo"),ee=document.getElementById("originalFileName"),te=document.getElementById("originalFileSize"),oe=document.getElementById("originalDuration"),ne=document.getElementById("originalResolution"),z=document.getElementById("qualitySlider"),re=document.getElementById("qualityValue"),T=document.getElementById("resolutionSelect"),v=document.getElementById("compressBtn"),W=document.getElementById("progressContainer"),x=document.getElementById("progressFill"),V=document.getElementById("progressText"),ie=document.getElementById("compressedVideoContainer"),c=document.getElementById("compressedVideo"),ae=document.getElementById("compressedInfo"),se=document.getElementById("compressedFileName"),de=document.getElementById("compressedFileSize"),ce=document.getElementById("compressionRatio"),le=document.getElementById("spaceSaved"),M=document.getElementById("downloadBtn"),me=document.getElementById("comparisonContainer"),ue=document.getElementById("noComparison"),pe=document.getElementById("compareOriginalVideo"),j=document.getElementById("compareCompressedVideo");function ge(){fe(),G()}function fe(){X.addEventListener("click",()=>H.click()),H.addEventListener("change",ve),h.addEventListener("dragover",ye),h.addEventListener("dragleave",he),h.addEventListener("drop",Be),z.addEventListener("input",G),T.addEventListener("change",()=>{console.log("分辨率已更改:",T.value)}),v.addEventListener("click",we)}function G(){re.textContent=`${z.value}%`}function ve(t){t.target.files.length>0&&K(t.target.files[0])}function ye(t){t.preventDefault(),h.classList.add("dragover")}function he(t){t.preventDefault(),h.classList.remove("dragover")}function Be(t){t.preventDefault(),h.classList.remove("dragover"),t.dataTransfer.files.length>0&&K(t.dataTransfer.files[0])}function K(t){if(!t.type.startsWith("video/")){alert("请上传视频文件！");return}if(t.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}y=t,Ee(t),v.disabled=!1}function Ee(t){const e=URL.createObjectURL(t);w.src=e,pe.src=e,Y.classList.remove("hidden"),w.onloadedmetadata=()=>{Z.classList.remove("hidden"),ee.textContent=t.name,te.textContent=P(t.size),oe.textContent=Fe(w.duration),ne.textContent=`${w.videoWidth} × ${w.videoHeight}`}}async function we(){if(y){v.disabled=!0,v.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',W.classList.remove("hidden"),x.style.width="0%",V.textContent="0%";try{const t=z.value,e=parseFloat(T.value);N=await Le(y,t,e),Ce(N),_()}catch(t){console.error("压缩失败:",t),alert("视频压缩失败，请重试！")}finally{v.disabled=!1,v.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',W.classList.add("hidden")}}}async function Le(t,e,r){return new Promise((a,n)=>{const o=document.createElement("video");o.src=URL.createObjectURL(t),o.playsInline=!0,o.muted=!0,o.preload="metadata",o.onloadedmetadata=async()=>{try{let b=function(){if(S)return;L.drawImage(o,0,0,f,B);const d=Date.now();if(d-$>=J){const A=Math.min(100,Math.round(o.currentTime/F*100));x.style.width=`${A}%`,V.textContent=`${A}%`,$=d}requestAnimationFrame(b)};var l=b;const s=Math.round(o.videoWidth*r),m=Math.round(o.videoHeight*r),f=s%2===0?s:s-1,B=m%2===0?m:m-1,p=document.createElement("canvas");p.width=f,p.height=B;const L=p.getContext("2d",{willReadFrequently:!0}),u=o.videoFrameRate||30,O=1e3/u,i=new MediaStream;await o.play();const k=o.captureStream(u).getAudioTracks();k.forEach(d=>{i.addTrack(d)}),p.captureStream(u).getVideoTracks().forEach(d=>{i.addTrack(d)}),console.log(`检测到 ${k.length} 个音频轨道`);let g="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(g)||(g="video/webm;codecs=vp9,opus",MediaRecorder.isTypeSupported(g)||(g=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4"));const I=Ie(e,f,B,u),R=128e3,D=I+R,C={mimeType:g,videoBitsPerSecond:I,audioBitsPerSecond:R,bitsPerSecond:D,frameRate:u,ignoreMutedMedia:!1,videoEncodingBitrate:I,audioEncodingBitrate:R};g.includes("webm")?C.bitsPerSecond=D:g.includes("mp4")&&(C.videoBitsPerSecond=I);const E=new MediaRecorder(i,C),q=[];E.ondataavailable=d=>{d.data.size>0&&q.push(d.data)},E.onstop=()=>{const d=new Blob(q,{type:E.mimeType,lastModified:Date.now()});a(d)},E.start(500);const F=o.duration;o.playbackRate=1;let $=0,S=!1,Q=!1;const Me=Math.ceil(F*u),J=100;o.addEventListener("ended",()=>{S=!0,E.stop(),o.pause(),x.style.width="100%",V.textContent="100%"}),o.addEventListener("pause",()=>{!S&&o.currentTime<F&&setTimeout(()=>{!S&&!Q&&o.play().catch(d=>console.error("Failed to continue playback:",d))},100)}),requestAnimationFrame(b),o.play(),o.playbackRate=1}catch(s){console.error("压缩过程错误:",s),n(s)}},o.onerror=l=>{console.error("视频加载错误:",l),n(new Error("视频加载失败"))}})}function Ie(t,e,r,a=30){const n=e*r*a*.15,o=t/100;return Math.round(n*o)}async function Se(t){console.log("Using optimized method to fix video metadata");try{const e=t.type;return console.log("Original blob type:",e),e.includes("mp4")?new Blob([t],{type:"video/mp4",lastModified:Date.now()}):await Re(t)}catch(e){return console.error("Video metadata fix failed:",e),t}}async function Re(t){console.log("Converting video to MP4 format");const e=document.createElement("video");e.src=URL.createObjectURL(t),e.muted=!0,e.playsInline=!0,e.preload="auto",await new Promise((i,U)=>{e.onloadedmetadata=i,e.onerror=U}),await e.play(),e.pause();const r=document.createElement("canvas");r.width=e.videoWidth,r.height=e.videoHeight;const a=r.getContext("2d"),n=e.videoFrameRate||30,o=1e3/n,l=r.captureStream(n);let s="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(s)||(s="video/mp4");const m=new MediaRecorder(l,{mimeType:s,videoBitsPerSecond:2e6,audioBitsPerSecond:128e3,frameRate:n}),f=[];m.ondataavailable=i=>{i.data.size>0&&f.push(i.data)};const B=new Promise(i=>{m.onstop=()=>{i(new Blob(f,{type:s,lastModified:Date.now()}))}});m.start(1e3),e.play();let p=!0,L=0;const u=i=>{p&&(i-L>=o&&(a.drawImage(e,0,0,r.width,r.height),L=i),!e.paused&&!e.ended?requestAnimationFrame(u):(p=!1,m.stop()))};requestAnimationFrame(u),await new Promise(i=>{e.onended=i});const O=await B;return e.pause(),URL.revokeObjectURL(e.src),O}async function Ce(t){const e=await Se(t),r=URL.createObjectURL(e);c.src=r,j.src=r,c.controls=!0,j.controls=!0,ie.classList.remove("hidden"),M.href=r;const a=y.name.replace(/\.[^/.]+$/,"");M.download=`compressed_${a}.mp4`,M.classList.remove("hidden"),_(),c.onloadedmetadata=()=>{ae.classList.remove("hidden"),se.textContent=`compressed_${y.name}`,de.textContent=P(e.size);const n=y.size,o=e.size,l=((1-o/n)*100).toFixed(1),s=n-o;ce.textContent=`${l}%`,le.textContent=P(s),c.play().then(()=>{setTimeout(()=>{c.pause(),c.currentTime=0,console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",c.duration),console.log("视频可拖动范围:",c.seekable)},100)}).catch(m=>{console.error("视频播放失败:",m)})},c.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),c.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",c.currentTime)})}function _(){me.classList.remove("hidden"),ue.classList.add("hidden")}function P(t){if(t===0)return"0 Bytes";const e=1024,r=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,a)).toFixed(2))+" "+r[a]}function Fe(t){const e=Math.floor(t/60),r=Math.floor(t%60);return`${e}:${r.toString().padStart(2,"0")}`}ge();
