(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const t of n)if(t.type==="childList")for(const u of t.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function r(n){const t={};return n.integrity&&(t.integrity=n.integrity),n.referrerPolicy&&(t.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?t.credentials="include":n.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function i(n){if(n.ep)return;n.ep=!0;const t=r(n);fetch(n.href,t)}})();let h=null,G=null;const d=document.getElementById("uploadArea"),K=document.getElementById("fileInput"),oe=document.getElementById("browseBtn"),U=document.getElementById("originalVideoContainer"),l=document.getElementById("originalVideo"),ne=document.getElementById("originalInfo"),re=document.getElementById("originalFileName"),ie=document.getElementById("originalFileSize"),se=document.getElementById("originalDuration"),ae=document.getElementById("originalResolution"),I=document.getElementById("qualitySlider"),ce=document.getElementById("qualityValue"),O=document.getElementById("resolutionSelect"),v=document.getElementById("compressBtn"),_=document.getElementById("progressContainer"),R=document.getElementById("progressFill"),z=document.getElementById("progressText"),$=document.getElementById("compressedVideoContainer"),a=document.getElementById("compressedVideo"),de=document.getElementById("compressedInfo"),le=document.getElementById("compressedFileName"),ue=document.getElementById("compressedFileSize"),me=document.getElementById("compressionRatio"),pe=document.getElementById("spaceSaved"),V=document.getElementById("downloadBtn"),k=document.getElementById("comparisonContainer"),ge=document.getElementById("noComparison"),w=document.getElementById("compareOriginalVideo"),b=document.getElementById("compareCompressedVideo");function fe(){ye(),q(),ve(),he()}function ye(){oe.addEventListener("click",()=>K.click()),K.addEventListener("change",Be),d.addEventListener("dragover",Le),d.addEventListener("dragleave",Ie),d.addEventListener("drop",we),I.addEventListener("input",q),O.addEventListener("change",()=>{console.log("分辨率已更改:",O.value)}),v.addEventListener("click",Me)}function q(){ce.textContent=`${I.value}%`}function ve(){d.addEventListener("touchstart",()=>{d.classList.add("dragover")}),d.addEventListener("touchend",()=>{d.classList.remove("dragover")}),[U,$].forEach(r=>{r.addEventListener("dblclick",()=>{const i=r.querySelector("video");i&&Ee(i)})});let o=0;k.addEventListener("touchstart",r=>{o=r.touches[0].clientX}),k.addEventListener("touchend",r=>{const n=r.changedTouches[0].clientX-o;Math.abs(n)>50&&console.log("Swipe detected:",n>0?"right":"left")})}function he(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(document.body.classList.add("mobile-device"),console.log("Mobile device detected, applying mobile optimizations"),I.value=Math.min(I.value,80),q(),document.addEventListener("click",o=>{[U,$].forEach(i=>{i.contains(o.target)})}))}function Ee(e){document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch(o=>{console.error(`Error attempting to enable fullscreen: ${o.message}`)})}function j(e){document.body.classList.contains("mobile-device")&&e.videoWidth>1280&&e.classList.add("mobile-video")}function Be(e){e.target.files.length>0&&Q(e.target.files[0])}function Le(e){e.preventDefault(),d.classList.add("dragover")}function Ie(e){e.preventDefault(),d.classList.remove("dragover")}function we(e){e.preventDefault(),d.classList.remove("dragover"),e.dataTransfer.files.length>0&&Q(e.dataTransfer.files[0])}function Q(e){if(!e.type.startsWith("video/")){alert("请上传视频文件！");return}if(e.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}h=e,be(e),v.disabled=!1}function be(e){const o=URL.createObjectURL(e);l.src=o,l.crossOrigin="anonymous",l.playsInline=!0,l.muted=!0,w.src=o,w.crossOrigin="anonymous",w.playsInline=!0,w.muted=!0,U.classList.remove("hidden"),l.onloadedmetadata=()=>{ne.classList.remove("hidden"),re.textContent=e.name,ie.textContent=D(e.size),se.textContent=xe(l.duration),ae.textContent=`${l.videoWidth} × ${l.videoHeight}`,j(l)}}async function Me(){if(h){v.disabled=!0,v.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',_.classList.remove("hidden"),R.style.width="0%",z.textContent="0%";try{const e=I.value,o=parseFloat(O.value);G=await Se(h,e,o),Fe(G),J()}catch(e){console.error("压缩失败:",e),alert("视频压缩失败，请重试！")}finally{v.disabled=!1,v.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',_.classList.add("hidden")}}}async function Se(e,o,r){return new Promise((i,n)=>{const t=document.createElement("video");t.src=URL.createObjectURL(e),t.playsInline=!0,t.muted=!0,t.preload="auto",t.crossOrigin="anonymous",t.onloadedmetadata=async()=>{try{let C=function(){if(p)return;if(Date.now()-X>3e3){console.log("视频可能卡住，尝试恢复播放");try{t.currentTime=Math.min(t.currentTime+1,y-1),t.play().catch(c=>console.error("恢复播放失败:",c))}catch(c){console.error("调整视频位置失败:",c),p=!0,g.stop(),t.pause()}}p||setTimeout(C,2e3)},F=function(){if(!p){try{Y.drawImage(t,0,0,S,T);const s=Date.now();if(s-H>=ee){const c=Math.min(100,Math.round(t.currentTime/y*100));R.style.width=`${c}%`,z.textContent=`${c}%`,H=s}}catch(s){console.error("绘制帧失败:",s)}requestAnimationFrame(F)}};var u=C,P=F;const m=Math.round(t.videoWidth*r),M=Math.round(t.videoHeight*r),S=m%2===0?m:m-1,T=M%2===0?M:M-1,E=document.createElement("canvas");E.width=S,E.height=T;const Y=E.getContext("2d"),f=t.videoFrameRate||30;navigator.userAgent.match(/mobile/i)&&(f=Math.min(f,24));let B="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(B)||(B="video/mp4",MediaRecorder.isTypeSupported(B)||(B=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4"));const A=Te(o,S,T,f),N=128e3,Ve=A+N,Z={mimeType:B,videoBitsPerSecond:A,audioBitsPerSecond:N};let L;try{await t.play();const s=t.captureStream(f),c=E.captureStream(f);L=new MediaStream,s.getAudioTracks().forEach(x=>{L.addTrack(x)}),c.getVideoTracks().forEach(x=>{L.addTrack(x)})}catch(s){console.warn("音频处理失败，将仅处理视频:",s),L=E.captureStream(f)}const g=new MediaRecorder(L,Z),W=[];g.ondataavailable=s=>{s.data.size>0&&W.push(s.data)},g.onstop=()=>{const s=new Blob(W,{type:g.mimeType,lastModified:Date.now()});i(s)},g.start(1e3);const y=t.duration;t.playbackRate=1;let H=0,p=!1;const ee=200;t.addEventListener("ended",()=>{console.log("视频播放结束，停止录制"),p=!0,g.stop(),t.pause(),R.style.width="100%",z.textContent="100%"});let X=0;t.addEventListener("timeupdate",()=>{X=Date.now(),t.currentTime>=y-.5&&!p&&console.log("视频接近结束，准备停止录制")}),setTimeout(C,3e3),requestAnimationFrame(F);try{await t.play(),console.log("视频播放开始，总时长:",y)}catch(s){console.error("视频播放失败:",s);try{t.muted=!0,await t.play(),console.log("静音模式下视频播放成功")}catch(c){console.error("静音播放也失败:",c),n(new Error("视频播放失败，请确保已授予必要的权限"));return}}const te=y*3;setTimeout(()=>{p||(console.log("超时强制停止，当前进度:",(t.currentTime/y*100).toFixed(2)+"%"),p=!0,g.stop(),t.pause())},te*1e3)}catch(m){console.error("压缩过程错误:",m),n(m)}},t.onerror=u=>{console.error("视频加载错误:",u),n(new Error("视频加载失败"))}})}function Te(e,o,r,i=30){const n=o*r*i*.15,t=e/100;return Math.round(n*t)}async function Ce(e){console.log("Using optimized method to fix video metadata");try{const o=e.type;return console.log("Original blob type:",o),o.includes("mp4")?new Blob([e],{type:"video/mp4",lastModified:Date.now()}):e}catch(o){return console.error("Video metadata fix failed:",o),e}}async function Fe(e){const o=await Ce(e),r=URL.createObjectURL(o);a.src=r,b.src=r,a.playsInline=!0,a.muted=!0,b.playsInline=!0,b.muted=!0,a.controls=!0,b.controls=!0,$.classList.remove("hidden"),V.href=r;const i=h.name.replace(/\.[^/.]+$/,"");V.download=`compressed_${i}.mp4`,V.classList.remove("hidden"),J(),a.onloadedmetadata=()=>{de.classList.remove("hidden"),le.textContent=`compressed_${h.name}`,ue.textContent=D(o.size);const n=h.size,t=o.size,u=((1-t/n)*100).toFixed(1),P=n-t;me.textContent=`${u}%`,pe.textContent=D(P),j(a),a.play().then(()=>{setTimeout(()=>{a.pause(),a.currentTime=0,console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",a.duration),console.log("视频可拖动范围:",a.seekable)},100)}).catch(m=>{console.error("视频自动播放失败:",m)})},a.onerror=n=>{console.error("压缩视频加载失败:",n),alert("视频加载失败，请尝试下载后观看")},a.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),a.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",a.currentTime)})}function J(){k.classList.remove("hidden"),ge.classList.add("hidden")}function D(e){if(e===0)return"0 Bytes";const o=1024,r=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(o));return parseFloat((e/Math.pow(o,i)).toFixed(2))+" "+r[i]}function xe(e){const o=Math.floor(e/60),r=Math.floor(e%60);return`${o}:${r.toString().padStart(2,"0")}`}fe();
