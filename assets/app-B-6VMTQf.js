let y=null,G=null;const d=document.getElementById("uploadArea"),_=document.getElementById("fileInput"),oe=document.getElementById("browseBtn"),U=document.getElementById("originalVideoContainer"),l=document.getElementById("originalVideo"),ne=document.getElementById("originalInfo"),ie=document.getElementById("originalFileName"),re=document.getElementById("originalFileSize"),se=document.getElementById("originalDuration"),ae=document.getElementById("originalResolution"),L=document.getElementById("qualitySlider"),ce=document.getElementById("qualityValue"),V=document.getElementById("resolutionSelect"),f=document.getElementById("compressBtn"),j=document.getElementById("progressContainer"),R=document.getElementById("progressFill"),z=document.getElementById("progressText"),$=document.getElementById("compressedVideoContainer"),r=document.getElementById("compressedVideo"),de=document.getElementById("compressedInfo"),le=document.getElementById("compressedFileName"),me=document.getElementById("compressedFileSize"),ue=document.getElementById("compressionRatio"),pe=document.getElementById("spaceSaved"),k=document.getElementById("downloadBtn"),D=document.getElementById("comparisonContainer"),ge=document.getElementById("noComparison"),w=document.getElementById("compareOriginalVideo"),b=document.getElementById("compareCompressedVideo");function ve(){fe(),q(),ye(),he()}function fe(){oe.addEventListener("click",()=>_.click()),_.addEventListener("change",Be),d.addEventListener("dragover",Le),d.addEventListener("dragleave",Ie),d.addEventListener("drop",we),L.addEventListener("input",q),V.addEventListener("change",()=>{console.log("分辨率已更改:",V.value)}),f.addEventListener("click",Te)}function q(){ce.textContent=`${L.value}%`}function ye(){d.addEventListener("touchstart",()=>{d.classList.add("dragover")}),d.addEventListener("touchend",()=>{d.classList.remove("dragover")}),[U,$].forEach(n=>{n.addEventListener("dblclick",()=>{const s=n.querySelector("video");s&&Ee(s)})});let o=0;D.addEventListener("touchstart",n=>{o=n.touches[0].clientX}),D.addEventListener("touchend",n=>{const a=n.changedTouches[0].clientX-o;Math.abs(a)>50&&console.log("Swipe detected:",a>0?"right":"left")})}function he(){/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(document.body.classList.add("mobile-device"),console.log("Mobile device detected, applying mobile optimizations"),L.value=Math.min(L.value,80),q(),document.addEventListener("click",o=>{[U,$].forEach(s=>{s.contains(o.target)})}))}function Ee(e){document.fullscreenElement?document.exitFullscreen():e.requestFullscreen().catch(o=>{console.error(`Error attempting to enable fullscreen: ${o.message}`)})}function K(e){document.body.classList.contains("mobile-device")&&e.videoWidth>1280&&e.classList.add("mobile-video")}function Be(e){e.target.files.length>0&&Q(e.target.files[0])}function Le(e){e.preventDefault(),d.classList.add("dragover")}function Ie(e){e.preventDefault(),d.classList.remove("dragover")}function we(e){e.preventDefault(),d.classList.remove("dragover"),e.dataTransfer.files.length>0&&Q(e.dataTransfer.files[0])}function Q(e){if(!e.type.startsWith("video/")){alert("请上传视频文件！");return}if(e.size>1024*1024*1024){alert("视频文件大小不能超过1GB！");return}y=e,be(e),f.disabled=!1}function be(e){const o=URL.createObjectURL(e);l.src=o,l.crossOrigin="anonymous",l.playsInline=!0,l.muted=!0,w.src=o,w.crossOrigin="anonymous",w.playsInline=!0,w.muted=!0,U.classList.remove("hidden"),l.onloadedmetadata=()=>{ne.classList.remove("hidden"),ie.textContent=e.name,re.textContent=O(e.size),se.textContent=xe(l.duration),ae.textContent=`${l.videoWidth} × ${l.videoHeight}`,K(l)}}async function Te(){if(y){f.disabled=!0,f.innerHTML='<i class="fa fa-spinner fa-spin mr-2"></i> 压缩中...',j.classList.remove("hidden"),R.style.width="0%",z.textContent="0%";try{const e=L.value,o=parseFloat(V.value);G=await Me(y,e,o),Fe(G),J()}catch(e){console.error("压缩失败:",e),alert("视频压缩失败，请重试！")}finally{f.disabled=!1,f.innerHTML='<i class="fa fa-cog mr-2"></i> 开始压缩',j.classList.add("hidden")}}}async function Me(e,o,n){return new Promise((s,a)=>{const t=document.createElement("video");t.src=URL.createObjectURL(e),t.playsInline=!0,t.muted=!0,t.preload="auto",t.crossOrigin="anonymous",t.onloadedmetadata=async()=>{try{let C=function(){if(u)return;if(Date.now()-N>3e3){console.log("视频可能卡住，尝试恢复播放");try{t.currentTime=Math.min(t.currentTime+1,v-1),t.play().catch(c=>console.error("恢复播放失败:",c))}catch(c){console.error("调整视频位置失败:",c),u=!0,p.stop(),t.pause()}}u||setTimeout(C,2e3)},F=function(){if(!u){try{Y.drawImage(t,0,0,M,S);const i=Date.now();if(i-X>=ee){const c=Math.min(100,Math.round(t.currentTime/v*100));R.style.width=`${c}%`,z.textContent=`${c}%`,X=i}}catch(i){console.error("绘制帧失败:",i)}requestAnimationFrame(F)}};var I=C,A=F;const m=Math.round(t.videoWidth*n),T=Math.round(t.videoHeight*n),M=m%2===0?m:m-1,S=T%2===0?T:T-1,h=document.createElement("canvas");h.width=M,h.height=S;const Y=h.getContext("2d");let g=t.videoFrameRate||30;navigator.userAgent.match(/mobile/i)&&(g=Math.min(g,24));let E="video/mp4;codecs=avc1.42E01E,mp4a.40.2";MediaRecorder.isTypeSupported(E)||(E="video/mp4",MediaRecorder.isTypeSupported(E)||(E=MediaRecorder.isTypeSupported("video/webm")?"video/webm":"video/mp4"));const P=Se(o,M,S,g),W=128e3,ke=P+W,Z={mimeType:E,videoBitsPerSecond:P,audioBitsPerSecond:W};let B;try{await t.play();const i=t.captureStream(g),c=h.captureStream(g);B=new MediaStream,i.getAudioTracks().forEach(x=>{B.addTrack(x)}),c.getVideoTracks().forEach(x=>{B.addTrack(x)})}catch(i){console.warn("音频处理失败，将仅处理视频:",i),B=h.captureStream(g)}const p=new MediaRecorder(B,Z),H=[];p.ondataavailable=i=>{i.data.size>0&&H.push(i.data)},p.onstop=()=>{const i=new Blob(H,{type:p.mimeType,lastModified:Date.now()});s(i)},p.start(1e3);const v=t.duration;t.playbackRate=1;let X=0,u=!1;const ee=200;t.addEventListener("ended",()=>{console.log("视频播放结束，停止录制"),u=!0,p.stop(),t.pause(),R.style.width="100%",z.textContent="100%"});let N=0;t.addEventListener("timeupdate",()=>{N=Date.now(),t.currentTime>=v-.5&&!u&&console.log("视频接近结束，准备停止录制")}),setTimeout(C,3e3),requestAnimationFrame(F);try{await t.play(),console.log("视频播放开始，总时长:",v)}catch(i){console.error("视频播放失败:",i);try{t.muted=!0,await t.play(),console.log("静音模式下视频播放成功")}catch(c){console.error("静音播放也失败:",c),a(new Error("视频播放失败，请确保已授予必要的权限"));return}}const te=v*3;setTimeout(()=>{u||(console.log("超时强制停止，当前进度:",(t.currentTime/v*100).toFixed(2)+"%"),u=!0,p.stop(),t.pause())},te*1e3)}catch(m){console.error("压缩过程错误:",m),a(m)}},t.onerror=I=>{console.error("视频加载错误:",I),a(new Error("视频加载失败"))}})}function Se(e,o,n,s=30){const a=o*n*s*.15,t=e/100;return Math.round(a*t)}async function Ce(e){console.log("Using optimized method to fix video metadata");try{const o=e.type;return console.log("Original blob type:",o),o.includes("mp4")?new Blob([e],{type:"video/mp4",lastModified:Date.now()}):e}catch(o){return console.error("Video metadata fix failed:",o),e}}async function Fe(e){const o=await Ce(e),n=URL.createObjectURL(o);r.src=n,b.src=n,r.playsInline=!0,r.muted=!0,b.playsInline=!0,b.muted=!0,r.controls=!0,b.controls=!0,$.classList.remove("hidden"),k.href=n;const s=y.name.replace(/\.[^/.]+$/,"");k.download=`compressed_${s}.mp4`,k.classList.remove("hidden"),J(),r.onloadedmetadata=()=>{de.classList.remove("hidden"),le.textContent=`compressed_${y.name}`,me.textContent=O(o.size);const a=y.size,t=o.size,I=((1-t/a)*100).toFixed(1),A=a-t;ue.textContent=`${I}%`,pe.textContent=O(A),K(r),r.play().then(()=>{setTimeout(()=>{r.pause(),r.currentTime=0,console.log("视频已准备就绪，现在支持进度条拖动！"),console.log("视频时长:",r.duration),console.log("视频可拖动范围:",r.seekable)},100)}).catch(m=>{console.error("视频自动播放失败:",m)})},r.onerror=a=>{console.error("压缩视频加载失败:",a),alert("视频加载失败，请尝试下载后观看")},r.addEventListener("seeking",()=>{console.log("正在拖动进度条...")}),r.addEventListener("seeked",()=>{console.log("进度条拖动完成，当前时间:",r.currentTime)})}function J(){D.classList.remove("hidden"),ge.classList.add("hidden")}function O(e){if(e===0)return"0 Bytes";const o=1024,n=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(o));return parseFloat((e/Math.pow(o,s)).toFixed(2))+" "+n[s]}function xe(e){const o=Math.floor(e/60),n=Math.floor(e%60);return`${o}:${n.toString().padStart(2,"0")}`}ve();
